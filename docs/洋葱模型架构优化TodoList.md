# 微调生命周期工作流系统 - 洋葱模型架构优化 TodoList

## 分析现状

### 当前架构分析
✅ **已完成的DDD设计**：
- 领域边界上下文划分清晰
- 聚合根、实体、值对象定义完整
- 领域事件机制设计
- 微服务架构分层（用户接口层、API网关层、应用服务层、领域服务层、基础设施层）

❌ **缺失的洋葱模型要素**：
- 缺少明确的防腐层(Anti-Corruption Layer)设计
- 领域模型不够充血，业务逻辑分散
- 依赖方向未严格按照洋葱模型设计
- 缺少端口和适配器模式实现

## 待完成事项清单

### 1. 洋葱模型架构重构 🎯

#### 1.1 核心层(Domain Core)优化
- [x] **充血领域模型设计** ✅ 已完成 📄 [实现文档](./微调生命周期工作流系统设计.md)
  - [x] 将业务逻辑从应用服务迁移到聚合根和实体中
  - [x] 为KnowledgeBase聚合根添加更多业务方法
  - [x] 为TrainingJob聚合根添加状态转换逻辑
  - [x] 为EvaluationJob聚合根添加评估计算逻辑
  - [x] 为InferenceSession聚合根添加会话管理逻辑

- [ ] **领域服务纯化**
  - [ ] 确保领域服务只包含纯业务逻辑
  - [ ] 移除领域服务中的基础设施依赖
  - [ ] 定义领域服务接口，实现依赖倒置

#### 1.2 应用层(Application Layer)重构
- [ ] **应用服务瘦身**
  - [ ] 应用服务只负责协调和编排
  - [ ] 移除应用服务中的业务逻辑
  - [ ] 实现事务边界管理
  - [ ] 添加应用服务接口定义

- [ ] **命令查询分离(CQRS)**
  - [ ] 设计Command和Query分离的应用服务
  - [ ] 实现CommandHandler和QueryHandler
  - [ ] 定义DTO对象用于数据传输

#### 1.3 端口层(Ports Layer)设计
- [ ] **定义领域端口接口**
  - [ ] DocumentRepository端口接口
  - [ ] ModelRepository端口接口
  - [ ] EvaluationRepository端口接口
  - [ ] EmbeddingService端口接口
  - [ ] ModelTrainingService端口接口
  - [ ] NotificationService端口接口

- [ ] **定义应用端口接口**
  - [ ] KnowledgeManagementPort
  - [ ] ModelTrainingPort
  - [ ] QualityAssessmentPort
  - [ ] InferencePort
  - [ ] WorkflowOrchestrationPort

#### 1.4 适配器层(Adapters Layer)实现
- [ ] **基础设施适配器**
  - [ ] PostgreSQL数据库适配器
  - [ ] FAISS向量存储适配器
  - [ ] RabbitMQ消息队列适配器
  - [ ] Redis缓存适配器
  - [ ] 文件系统存储适配器

- [ ] **外部服务适配器**
  - [ ] HuggingFace模型服务适配器
  - [ ] OpenAI API适配器
  - [ ] 邮件通知服务适配器
  - [ ] 监控系统适配器

### 2. 防腐层(Anti-Corruption Layer)设计 🛡️ ✅ 已完成 📄 [实现文档](./防腐层设计.md)

#### 2.1 外部系统防腐层
- [x] **第三方模型服务防腐层**
  - [x] HuggingFace API防腐层
  - [x] OpenAI API防腐层
  - [x] 本地模型服务防腐层
  - [x] 统一模型服务接口

- [x] **存储系统防腐层**
  - [x] 关系型数据库防腐层
  - [x] 向量数据库防腐层
  - [x] 对象存储防腐层
  - [x] 缓存系统防腐层

- [x] **消息系统防腐层**
  - [x] RabbitMQ防腐层
  - [x] Kafka防腐层
  - [x] Redis Pub/Sub防腐层
  - [x] 统一消息接口

#### 2.2 微服务间防腐层
- [x] **服务间通信防腐层**
  - [x] 知识管理服务客户端防腐层
  - [x] 模型训练服务客户端防腐层
  - [x] 质量评估服务客户端防腐层
  - [x] 应用服务客户端防腐层

- [x] **数据转换层**
  - [x] 外部DTO到内部领域对象转换
  - [x] 内部领域对象到外部DTO转换
  - [x] 版本兼容性处理
  - [x] 数据格式标准化

### 3. 依赖倒置原则实现 🔄 ✅ 已完成 📄 [实现文档](./依赖倒置原则实现.md)

#### 3.1 依赖方向调整
- [x] **确保依赖方向正确**
  - [x] 基础设施层依赖应用层
  - [x] 应用层依赖领域层
  - [x] 领域层不依赖任何外层
  - [x] 通过接口实现依赖倒置

#### 3.2 依赖注入容器
- [x] **IoC容器配置**
  - [x] 配置依赖注入容器
  - [x] 定义服务生命周期
  - [x] 实现接口到实现的绑定
  - [x] 支持配置化依赖注入

### 4. 代码重构实施 🔧

#### 4.1 领域模型重构
- [ ] **KnowledgeBase聚合根重构**
  - [ ] 添加文档验证业务逻辑
  - [ ] 添加向量存储构建逻辑
  - [ ] 添加知识库状态管理
  - [ ] 实现领域事件发布

- [ ] **TrainingJob聚合根重构**
  - [ ] 添加训练参数验证逻辑
  - [ ] 添加训练状态转换逻辑
  - [ ] 添加增量训练合并逻辑
  - [ ] 实现训练进度跟踪

- [ ] **EvaluationJob聚合根重构**
  - [ ] 添加评估指标计算逻辑
  - [ ] 添加质量阈值判断逻辑
  - [ ] 添加模型比较逻辑
  - [ ] 实现评估报告生成

#### 4.2 应用服务重构 ✅ 已完成 📄 [实现文档](./应用服务重构实现.md)
- [x] **精简应用服务**
  - [x] 移除业务逻辑到领域层
  - [x] 保留协调和编排逻辑
  - [x] 添加事务管理
  - [x] 实现异常处理

#### 4.3 基础设施层重构 ✅ 已完成 📄 [实现文档](./基础设施层重构实现.md)
- [x] **Repository实现**
  - [x] 实现Repository接口
  - [x] 添加数据映射逻辑
  - [x] 实现查询优化
  - [x] 添加缓存机制

### 5. 测试策略调整 🧪 ✅ 已完成 📄 [实现文档](./测试策略调整实现.md)

#### 5.1 单元测试
- [x] **领域模型测试**
  - [x] 聚合根业务逻辑测试
  - [x] 领域服务测试
  - [x] 值对象测试
  - [x] 领域事件测试

#### 5.2 集成测试
- [x] **适配器测试**
  - [x] 数据库适配器测试
  - [x] 外部服务适配器测试
  - [x] 消息队列适配器测试
  - [x] 防腐层测试

#### 5.3 架构测试
- [x] **依赖方向测试**
  - [x] 验证依赖方向正确性
  - [x] 检查循环依赖
  - [x] 验证接口隔离
  - [x] 检查层次边界

### 6. 文档更新 📚 ✅ 已完成

#### 6.1 架构文档 📄 [架构文档](./洋葱模型架构文档.md)
- [x] **洋葱模型架构图**
  - [x] 绘制完整的洋葱模型架构图
  - [x] 标注各层职责和依赖关系
  - [x] 说明防腐层设计
  - [x] 展示端口和适配器模式

#### 6.2 设计文档 📄 [设计文档更新](./系统设计文档更新.md)
- [x] **更新系统设计文档**
  - [x] 添加洋葱模型章节
  - [x] 更新技术架构分层
  - [x] 补充防腐层设计
  - [x] 完善充血模型说明

## 优先级排序

### 🔥 高优先级 (P0)
1. 充血领域模型设计
2. 防腐层核心接口定义
3. 依赖方向调整
4. 端口接口定义

### ⚡ 中优先级 (P1)
1. 适配器层实现
2. 应用服务重构
3. 微服务间防腐层
4. IoC容器配置

### 📋 低优先级 (P2)
1. 测试策略调整
2. 文档更新
3. 架构测试
4. 性能优化

## 预估工作量

- **总工作量**: 约 15-20 个工作日
- **核心重构**: 8-10 个工作日
- **防腐层实现**: 4-6 个工作日
- **测试和文档**: 3-4 个工作日

## 📚 相关文档索引

### 核心设计文档
- 📄 [微调生命周期工作流系统设计](./微调生命周期工作流系统设计.md) - 充血领域模型设计
- 📄 [防腐层设计](./防腐层设计.md) - 外部系统防腐层实现
- 📄 [依赖倒置原则实现](./依赖倒置原则实现.md) - IoC容器和依赖注入配置

### 重构实现文档
- 📄 [应用服务重构实现](./应用服务重构实现.md) - 应用层精简和重构
- 📄 [基础设施层重构实现](./基础设施层重构实现.md) - Repository和适配器实现

### 测试和质量保证
- 📄 [测试策略调整实现](./测试策略调整实现.md) - 单元测试、集成测试、架构测试

### 架构文档
- 📄 [洋葱模型架构文档](./洋葱模型架构文档.md) - 完整的架构设计说明
- 📄 [系统设计文档更新](./系统设计文档更新.md) - 系统设计文档补充

---

**注意**: 请在开始实施前仔细审查此TodoList，根据实际情况调整优先级和工作量估算。建议采用渐进式重构方式，分阶段实施，确保系统稳定性。